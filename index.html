<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Line Buddy 2.0</title>
    <style>
        body {
            margin: 0;
            padding: 0;
            /* display: flex;
            justify-content: center;
            align-items: center; */
            height: 100%;
            width: 100%;
        }
    </style>
</head>
<body>
    <canvas id="canvas"></canvas>
    <script type="module">
        import init, {process_ways, process_relations, process_nodes} from './process-maps/pkg/process_maps.js';
        init();

        let canvas = document.getElementById('canvas');
        const queryString = window.location.search;
        const searchParams = new URLSearchParams(queryString);

        let park = searchParams.get('park');
        let n, w, s, e;

        switch (park) {
            case 'epcot':
                n = '28.3768';
                w = '-81.5553';
                s = '28.3661';
                e = '-81.5425';
                break;
            case 'hollywood_studios':
            case 'hs':
                n = '28.3625';
                w = '-81.5641';
                s = '28.3523';
                e = '-81.5561';
                break;
            case 'animal_kingdom':
            case 'ak':
                n = '28.3692';
                w = '-81.5984';
                s = '28.3524';
                e = '-81.5831';
                break;
            case 'magic_kingdom':
            case 'mk':
            default:
                n = '28.42278';
                w = '-81.58709';
                s = '28.41566';
                e = '-81.57547';
                break;
        }

        let bbox = `${s},${w},${n},${e}`;
        let buildings = `way[building][!name];foreach{(._;>;);out;}`;
        let named_buildings = `way[building][name];foreach{(._;>;);out;}`;
        let walkways = `way[highway];foreach{(._;>;);out;}`;
        let trees = `node[natural=tree];foreach{(._;>;);out;}`;
        let gardens = `way[leisure=garden];foreach{(._;>;);out;}`;
        let forests = `way[landuse=forest];foreach{(._;>;);out;}`;
        let water = `relation[natural=water];foreach{(._;>;);out;}`;
        let query = `[timeout:90][bbox:${bbox}];`;

        let ratio = (Math.abs(+w) - Math.abs(+e)) / (+n - +s);
        let width = 1280;
        let height = width * ratio;
        canvas.width = height;
        canvas.height = width;

        let ctx = canvas.getContext('2d');
        ctx.translate(0, width);
        ctx.rotate(-Math.PI / 2);

        let url = `https://overpass-api.de/api/interpreter?data=${query}`;
        getWater(url);

        function getWater(url) {
            fetch(url+`${water};out;`).then(response => {
                return response.text();
            }).then(data => {
                let p = process_relations(data, width, height);
                for (let water of p) {
                    ctx.beginPath();
                    for (let point of water) {
                        ctx.lineTo(point[0], point[1]);
                    }
                    ctx.fillStyle = 'rgb(83,156,156)';
                    ctx.fill();
                    ctx.closePath();
                }
                getGardens(url);
            });
        }

        function getWalkways(url) {
            fetch(url+`${walkways};out;`).then(response => {
                return response.text();
            }).then(data => {
                let p = process_ways(data, width, height);
                for (let walkway of p) {
                    ctx.beginPath();
                    for (let point of walkway) {
                        ctx.lineTo(point[0], point[1]);
                    }
                    ctx.strokeStyle = 'rgb(0,0,0)';
                    ctx.stroke();
                    ctx.closePath();
                }
                // getTrees(url);
                getBuildings(url);
            });
        }

        function getBuildings(url) {
            fetch(url+`${buildings};out;`).then(response => {
                return response.text();
            }).then(data => {
                let p = process_ways(data, width, height);
                for (let building of p) {
                    ctx.beginPath();
                    for (let point of building) {
                        ctx.lineTo(point[0], point[1]);
                    }
                    ctx.fillStyle = 'rgb(98,90,87)';
                    ctx.fill();
                    ctx.closePath();
                }
            });
            getNamedBuildings(url);
        }

        function getNamedBuildings(url) {
            fetch(url+`${named_buildings};out;`).then(response => {
                return response.text();
            }).then(data => {
                let p = process_ways(data, width, height);
                for (let building of p) {
                    ctx.beginPath();
                    for (let point of building) {
                        ctx.lineTo(point[0], point[1]);
                    }
                    ctx.fillStyle = 'rgb(227, 178, 73)';
                    ctx.fill();
                    ctx.closePath();
                }
            });
        }

        function getGardens(url) {
            fetch(url+`${gardens};${forests};out;`).then(response => {
                return response.text();
            }).then(data => {
                let p = process_ways(data, width, height);
                for (let garden of p) {
                    ctx.beginPath();
                    for (let point of garden) {
                        ctx.lineTo(point[0], point[1]);
                    }
                    ctx.fillStyle = 'rgb(136,172,140)';
                    ctx.fill();
                    ctx.closePath();
                }
                getWalkways(url);
            });
        }

        function getTrees(url) {
            fetch(url+`${trees};out;`).then(response => {
                return response.text();
            }).then(data => {
                let p = process_nodes(data, width, height);
                for (let tree of p) {
                    ctx.beginPath();
                    ctx.arc(tree[0], tree[1], 3, 0, 2 * Math.PI);
                    ctx.fillStyle = 'rgb(40,107,83)';
                    ctx.fill();
                    ctx.closePath();
                }
            });
        }
    </script>
</body>
</html>